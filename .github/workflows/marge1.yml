name: Merge M3U

on:
  schedule:
    - cron: '0 * * * *'
  workflow_dispatch:

jobs:
  merge-m3u:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repo
      uses: actions/checkout@v3

    - name: Merge into 98MB file
      run: |
        set -euo pipefail
        MAXSIZE=98000000
        TMPDIR="merged_tmp"
        OUTFILE="$TMPDIR/combined-playlist.m3u"

        rm -rf "$TMPDIR"
        mkdir -p "$TMPDIR"
        : > "$OUTFILE"

        find . -type f -name "*.m3u" ! -path "./$TMPDIR/*" ! -name "MERGED_VOD.m3u" ! -name "combined-playlist.m3u" | \
        while read -r file; do
          base=$(basename "$file" .m3u)

          awk -v grp="$base" '
            BEGIN { inblock=0; block="" }
            /^#EXTINF/ {
              if (inblock) { print block; block="" }
              line=$0
              if (line ~ /group-title="/) {
                sub(/group-title="[^"]*"/, "group-title=\"" grp "\"", line)
              } else {
                sub(/^#EXTINF:/, "#EXTINF:-1 group-title=\"" grp "\"," , line)
              }
              block=line "\n"
              inblock=1
              next
            }
            {
              if (inblock) block = block $0 "\n"
            }
            END { if (inblock) print block }
          ' "$file" | while IFS= read -r entry; do

            if [ -f "$OUTFILE" ]; then
              PREV_SIZE=$(stat -c%s "$OUTFILE" || echo 0)
            else
              PREV_SIZE=0
            fi

            printf '%s\n' "$entry" >> "$OUTFILE"
            NEW_SIZE=$(stat -c%s "$OUTFILE" || echo 0)

            if [ "$NEW_SIZE" -ge "$MAXSIZE" ]; then
              truncate -s "$PREV_SIZE" "$OUTFILE"
              exit 0
            fi
          done
        done

        if ! head -n1 "$OUTFILE" | grep -q "^#EXTM3U"; then
          sed -i '1i #EXTM3U' "$OUTFILE"
        fi

        mv "$OUTFILE" MERGED_VOD.m3u
        rm -rf "$TMPDIR"

    - name: Commit and push merged playlist
      run: |
        git config user.name "${{ secrets.GIT_U }}"
        git config user.email "${{ secrets.GIT_E }}"
        git add MERGED_VOD.m3u || true
        if ! git diff --cached --quiet; then
          git commit -m "Auto-merged m3u (98MB limit) $(date -u +"%Y-%m-%d %H:%M UTC")"
          git push
        else
          echo "No changes to commit"
        fi
